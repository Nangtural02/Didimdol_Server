<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>모델 성능 평가 제어판</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; }
        .container { border: 1px solid #ddd; background-color: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        button { font-size: 1.2em; padding: 12px 24px; margin: 5px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .start-button { background-color: #4CAF50; color: white; } /* 초록색 계열 */
        .stop-button { background-color: #f44336; color: white; } /* 빨간색 계열 */
        .rep-start-button { background-color: #2196F3; color: white; } /* 파란색 계열 */
        .rep-stop-button { background-color: #ff9800; color: white; } /* 주황색 계열 */
        #status, #repCount { font-size: 1.5em; margin: 10px; font-weight: bold; color: #555; }
    </style>
</head>
<body>
    <h1>모델 성능 평가 제어판</h1>

    <div class="container">
        <h2>전체 측정</h2>
        <!-- ✅ '전체 측정'을 위한 단일 토글 버튼 -->
        <button id="btnToggleOverall">측정 시작</button>
    </div>

    <div class="container">
        <h2>1회 스쿼트</h2>
        <!-- ✅ '1회 스쿼트'를 위한 단일 토글 버튼 -->
        <button id="btnToggleRep" disabled>회차 시작</button>
    </div>

    <div>상태: <span id="status">대기 중</span></div>
    <div>현재 횟수: <span id="repCount">0</span></div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}/model-test-ws`);

        const btnToggleOverall = document.getElementById('btnToggleOverall');
        const btnToggleRep = document.getElementById('btnToggleRep');
        const statusEl = document.getElementById('status');
        const repCountEl = document.getElementById('repCount');

        // ✅ 현재 상태를 추적하기 위한 변수
        let isOverallTestRunning = false;
        let isRepRecording = false;

        // 초기 버튼 스타일 설정
        btnToggleOverall.className = 'start-button';
        btnToggleRep.className = 'rep-start-button';

        function sendCommand(command) {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command }));
            }
        }

        ws.onopen = () => { statusEl.textContent = '서버 연결됨'; };
        ws.onclose = () => {
            statusEl.textContent = '서버 연결 끊김';
            // 모든 버튼 비활성화 및 초기화
            isOverallTestRunning = false;
            isRepRecording = false;
            updateOverallButtonUI();
            updateRepButtonUI();
        };
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            statusEl.textContent = data.status;
            if (data.rep_count !== undefined) {
                repCountEl.textContent = data.rep_count;
            }
        };

        // --- UI 업데이트 함수 ---
        function updateOverallButtonUI() {
            if (isOverallTestRunning) {
                btnToggleOverall.textContent = '측정 종료';
                btnToggleOverall.className = 'stop-button';
                btnToggleOverall.disabled = false;
                btnToggleRep.disabled = false; // 측정 시작 시 회차 버튼 활성화
            } else {
                btnToggleOverall.textContent = '측정 시작';
                btnToggleOverall.className = 'start-button';
                btnToggleOverall.disabled = false;
                btnToggleRep.disabled = true; // 측정 종료 시 회차 버튼 비활성화
                repCountEl.textContent = '0'; // 전체 종료 시 카운트 초기화
            }
        }

        function updateRepButtonUI() {
            if (isRepRecording) {
                btnToggleRep.textContent = '회차 종료';
                btnToggleRep.className = 'rep-stop-button';
            } else {
                btnToggleRep.textContent = '회차 시작';
                btnToggleRep.className = 'rep-start-button';
            }
        }

        // --- 버튼 클릭 이벤트 핸들러 ---
        btnToggleOverall.onclick = () => {
            if (isOverallTestRunning) { // 현재 '측정 종료' 상태일 때
                sendCommand('stop_overall_test');
            } else { // 현재 '측정 시작' 상태일 때
                sendCommand('start_overall_test');
            }
            isOverallTestRunning = !isOverallTestRunning; // 상태 반전
            updateOverallButtonUI();

            // 전체 측정이 중단되면, 회차 측정 상태도 강제로 초기화
            if (!isOverallTestRunning && isRepRecording) {
                isRepRecording = false;
                updateRepButtonUI();
            }
        };

        btnToggleRep.onclick = () => {
            if (isRepRecording) { // 현재 '회차 종료' 상태일 때
                sendCommand('stop_rep');
            } else { // 현재 '회차 시작' 상태일 때
                sendCommand('start_rep');
            }
            isRepRecording = !isRepRecording; // 상태 반전
            updateRepButtonUI();
        };

    </script>
</body>
</html>